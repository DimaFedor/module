# Сховище аудиторських доказів (Team 7)

Це настільний застосунок на Electron для керування аудиторськими доказами, версіями файлів, журналом аудиту та формуванням експортних пакетів (ZIP + український PDF-звіт) для зовнішніх аудиторів.

## Технічний стек

- **Electron + contextIsolation + preload** — безпечний бекенд на локальній машині з доступом до файлової системи, SQLite та нативних діалогів.
- **React + TypeScript** — зрозумілий та типобезпечний інтерфейс користувача.
- **Vite** — швидкий дев-сервер та збірка фронтенду.
- **SQLite (better-sqlite3)** — локальне надійне сховище даних без окремого серверу.
- **PDFKit + archiver** — формування українського PDF-звіту та ZIP-пакету з файлами доказів.

Такий стек дає просту доставку (один двійковий застосунок), чіткий поділ привілейованих дій (main process) і швидкий UI без важких UI-фреймворків.

## Структура проєкту

- `electron/` — основний процес Electron та preload:
  - `main.ts` — створення вікна, ініціалізація SQLite, IPC-обробники, експорт ZIP+PDF.
  - `preload.ts` — безпечний міст `window.electronApi` з типізованими методами.
  - `utils/paths.ts` — обробка шляхів до ресурсів (шрифт для PDF тощо).
- `renderer/` — React/Vite фронтенд:
  - `src/main.tsx` — вхідна точка React.
  - `src/app/AppShell.tsx` — каркас застосунку, сайдбар, хедер, роутинг.
  - `src/pages/` — екран Панелі, Сховища доказів, Форми, Журналу аудиту, Експорту.
  - `src/components/ui/` — невеликий in-house UI-kit (кнопки, поля, таблиці, модалки, снакбар).
  - `src/theme/` — тема (light/dark) через CSS-змінні та `data-theme` на `<html>`.
  - `src/i18n/` — простий словник українських текстів та функція `t(key)`.
  - `src/services/` — обгортки над `window.electronApi` (evidence/audit/export).
- `database/schema.sql` — схема SQLite (evidence, tags, evidence_tags, audit_log).
- `assets/fonts/NotoSans-Regular.ttf` — TTF-шрифт з підтримкою кирилиці для PDF.

## Запуск

1. Встановіть залежності:

```bash
npm install
```

2. Запустіть дев-середовище (Vite + компіляція Electron + запуск Electron):

```bash
npm run dev
```

3. Збірка продакшн-версії (рендерер + main/preload у `electron-dist/` і `renderer-dist/`):

```bash
npm run build
```

4. Запуск зібраної версії:

```bash
npm start
```

> Команди та шляхи залишені без змін, щоб узгоджуватися з `package.json`.

## Основні можливості

- **Сховище доказів**
  - Таблиця з пошуком (назва, опис, теги) та фільтрами (статус, категорія).
  - Сортування за датою створення або статусом.
  - Пагінація.
  - Стан `loading` / `empty` / `error` з кнопкою «Повторити».
  - Опція «Показати історію (усі версії)» або за замовчуванням — лише останні версії.

- **Форма створення/редагування доказу**
  - Поля: Назва, Категорія, Статус, Теги (через кому), Файл доказу (через діалог), Опис.
  - Валідація з inline-помилками під полями; без `alert()`.
  - Вибір файлу відбувається в main-процесі, файл копіюється у папку `userData/evidence-files`.
  - Редагування створює новий рядок-версію (з тим самим `version_group_id` та більшим `version_number`), історичні версії не видаляються.

- **Журнал аудиту**
  - Таблиця з останніми 500 записами.
  - Фіксуються ключові дії: `DELETE`, `STATUS_CHANGE`, `EXPORT_PACKAGE`.
  - Стан `empty/error/loading` з можливістю оновлення.

- **Експортний пакет**
  - Фільтри за статусом та категорією для включених доказів.
  - Створення ZIP-файлу, який містить:
    - Український PDF-звіт з переліком доказів.
    - Файли доказів з локального сховища.

- **Тема та UX**
  - Перемикач світлої/темної теми в хедері; стан зберігається в `localStorage`.
  - Адаптивна сітка з максимумом ширини контенту ~1100px.
  - Автооновлення таблиці сховища (15/30/60 секунд) за бажанням користувача.
  - Клавіатурні шорткати:
    - `Cmd+N` / `Ctrl+N` — новий доказ.
    - `Cmd+F` / `Ctrl+F` — фокус у поле пошуку на сторінці сховища.
  - Видалення з підтвердженням та снакбаром з можливістю «Скасувати» протягом 5 секунд.

## Модель даних (SQLite)

Таблиці відповідають вимогам домену:

- `evidence` — метадані доказу (назва, опис, категорія, статус, шлях до файлу, група версій, номер версії, дати).
- `tags` — унікальні теги.
- `evidence_tags` — звʼязок «багато-до-багатьох» між доказами та тегами.
- `audit_log` — журнал дій над сутностями.

Версійність реалізована через `version_group_id` та `version_number`: кожне оновлення створює новий запис у тій самій групі, а список за замовчуванням показує лише останні версії.

## IPC та безпека

Усі привілейовані операції виконуються тільки в main-процесі Electron і доступні з рендерера через IPC:

- Запити до SQLite (CRUD для evidence/tags/audit_log).
- Копіювання файлів доказів у локальне сховище.
- Відкриття діалогу вибору файлу (`dialog.showOpenDialog`).
- Створення ZIP та PDF.
- Діалог збереження архіву (`dialog.showSaveDialog`).

У preload (`electron/preload.ts`) за допомогою `contextBridge.exposeInMainWorld` публікується обʼєкт `window.electronApi` з типізованими методами, описаними в `renderer/src/types/ipc.ts`. Рендерер не має прямого доступу до Node API.

## Нативні можливості Electron

- **Діалог вибору файлу**: користувач обирає файл доказу, а main-процес копіює його до директорії `userData/evidence-files`.
- **Збереження ZIP-пакету**: через системний діалог збереження користувач обирає місце для архіву, який створюється в main-процесі.
- **Тема системи**: preload може зчитати системну тему через IPC (`themeGetSystem`) та синхронізувати стан теми при першому запуску.

## Український PDF та шрифт

Для коректного відображення українського тексту у PDF-звіті використовується TTF-шрифт з підтримкою кирилиці:

- Файл шрифту: `assets/fonts/NotoSans-Regular.ttf`.
- У main-процесі шрифт реєструється в PDFKit:
  - знаходиться за допомогою `resolveFontPath()` (пошук у `app.getAppPath()`, `process.resourcesPath` та відносно `__dirname`);
  - якщо шрифт не знайдено, кидається зрозуміла помилка з переліком шляхів.
- Перед виведенням будь-якого українського тексту викликаються:
  - `doc.registerFont('NotoSans', fontPath)`;
  - `doc.font('NotoSans')`.
- Дата у звіті форматована для локалі `uk-UA`, заголовок — «Звіт аудиторського пакету», колонки — «Назва | Категорія | Статус | Версія | Теги».

PDF генерується на диску як окремий файл, а потім додається до ZIP через `archiver` як `report-ukrainian.pdf`, що гарантує бінарну безпеку й коректне збереження українських символів.

